<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistente Gobierno</title>
  <style>
    :root{
      --primary:#1e6bff;
      --text:#1b1f2a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --bg:#f2f4f8;
      --card:#ffffff;
      --shadow:0 18px 45px rgba(15,23,42,.16);
      --radius:22px;
    }
    *{ box-sizing:border-box; font-family: "Segoe UI", Arial, sans-serif; }
    body{ margin:0; background:transparent; }
    .wrap{
      height:100vh;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      border-radius:var(--radius);
      overflow:hidden;
    }
    .header{
      background:var(--card);
      padding:14px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .header-avatar{
      width:34px;
      height:34px;
      border-radius:50%;
      object-fit:cover;
      border:1px solid #d9dde4;
      background:#f1f3f7;
    }
    .header-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .header-title h1{
      font-size:15px;
      margin:0;
      color:var(--text);
      font-weight:700;
    }
    .header-title span{
      font-size:12px;
      color:var(--muted);
    }
    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .icon-btn{
      width:28px;
      height:28px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
      color:#475569;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .icon-btn:hover{ background:#f8fafc; }

    .tabs{
      display:flex;
      background:var(--card);
      padding:0 8px;
      gap:12px;
      border-bottom:1px solid var(--border);
    }
    .tab-btn{
      flex:1;
      border:none;
      background:transparent;
      padding:12px 0 10px;
      font-size:14px;
      color:#8a94a6;
      cursor:pointer;
      position:relative;
    }
    .tab-btn.active{
      color:var(--primary);
      font-weight:700;
    }
    .tab-btn.active::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:-1px;
      height:3px;
      border-radius:999px;
      background:var(--primary);
    }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .panel{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .panel-text{
      padding:16px;
      gap:12px;
      overflow:auto;
    }
    .messages{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .msg{
      max-width:88%;
      padding:12px 14px;
      border-radius:14px;
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .msg.bot{
      background:#f3f4f6;
      color:#1f2937;
      align-self:flex-start;
    }
    .msg.me{
      background:var(--primary);
      color:#fff;
      align-self:flex-end;
    }

    .footer{
      background:var(--card);
      padding:12px 14px 14px;
      border-top:1px solid var(--border);
    }
    .input-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input-row input{
      flex:1;
      border:1px solid #d6dbe3;
      padding:12px 14px;
      border-radius:999px;
      font-size:14px;
      outline:none;
    }
    .send-btn{
      border:none;
      background:var(--primary);
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(30,107,255,.28);
    }

    .panel-voice{
      align-items:center;
      justify-content:center;
      padding:20px 22px 8px;
      text-align:center;
      gap:16px;
    }
    .voice-avatar{
      width:140px;
      height:140px;
      border-radius:50%;
      object-fit:cover;
      border:1px solid #e0e6f0;
      background:#f1f3f9;
      box-shadow:0 10px 24px rgba(15,23,42,.15);
    }
    .voice-text{
      color:#1f2937;
      font-size:14px;
      line-height:1.45;
    }
    .voice-text strong{
      font-weight:600;
    }
    .voice-note{
      font-size:12px;
      color:#94a3b8;
      margin-top:2px;
    }
    .voice-status{
      font-size:13px;
      color:#64748b;
      min-height:18px;
    }
    .voice-controls{
      background:var(--card);
      padding:14px 18px 18px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:center;
      gap:18px;
    }
    .control-btn{
      width:52px;
      height:52px;
      border-radius:50%;
      border:none;
      background:#f1f5f9;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#64748b;
    }
    .control-btn svg{ width:22px; height:22px; }
    .control-btn.mic{
      background:#e7eefc;
      color:var(--primary);
    }
    .control-btn.mic.active{
      background:var(--primary);
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="header-left">
        <img class="header-avatar" id="header-avatar" src="avatar_idle.png" alt="Avatar" />
        <div class="header-title">
          <h1 id="title">Asistente Gobierno</h1>
          <span id="subtitle">Aguascalientes â€¢ Demo Web</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="min-btn" type="button" aria-label="Minimizar">â€”</button>
        <button class="icon-btn" id="close-btn" type="button" aria-label="Cerrar">Ã—</button>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Modo">
      <button class="tab-btn" id="tab-voice" role="tab" aria-selected="false" type="button">Voz</button>
      <button class="tab-btn active" id="tab-text" role="tab" aria-selected="true" type="button">Chat de texto</button>
    </nav>

    <main class="content">
      <section class="panel panel-text" id="panelText">
        <div class="messages" id="chat"></div>
      </section>

      <section class="panel panel-voice" id="panelVoice" style="display:none;">
        <img class="voice-avatar" id="voice-avatar" src="avatar_idle.png" alt="Avatar" />
        <div class="voice-text">
          <strong>Habla con tu asistente del Gobierno de Aguascalientes.</strong><br />
          Pulsa el micrÃ³fono para empezar.
        </div>
        <div class="voice-note">Nota: el reconocimiento de voz funciona mejor en Chrome (Web Speech API).</div>
        <div class="voice-status" id="voice-status">Listo para escucharte.</div>
      </section>
    </main>

    <footer class="footer" id="footerText">
      <div class="input-row">
        <input id="txt" placeholder="Escribe tu preguntaâ€¦" />
        <button class="send-btn" id="btn" type="button">Enviar</button>
      </div>
    </footer>

    <div class="voice-controls" id="footerVoice" style="display:none;">
      <button class="control-btn" type="button" aria-label="Video">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="7" width="12" height="10" rx="2"></rect>
          <path d="M15 10l6-3v10l-6-3z"></path>
        </svg>
      </button>
      <button class="control-btn mic" id="mic-btn" type="button" aria-label="MicrÃ³fono">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button>
      <button class="control-btn" type="button" aria-label="MÃ¡s">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="5" cy="12" r="2"></circle>
          <circle cx="12" cy="12" r="2"></circle>
          <circle cx="19" cy="12" r="2"></circle>
        </svg>
      </button>
      <button class="control-btn" id="voice-close" type="button" aria-label="Cerrar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const title = decodeURIComponent(params.get("title") || "Asistente Gobierno");
  const subtitle = decodeURIComponent(params.get("subtitle") || "Aguascalientes â€¢ Demo Web");
  const avatarIdle = decodeURIComponent(params.get("avatar") || "avatar_idle.png");
  const avatarTalking = decodeURIComponent(params.get("avatarTalk") || "avatar_talking.gif");

  document.getElementById("title").textContent = title;
  document.getElementById("subtitle").textContent = subtitle;
  document.getElementById("header-avatar").src = avatarIdle;
  document.getElementById("voice-avatar").src = avatarIdle;

  const API_CHAT = "/GeaAsistenteHub/api/agente.ashx";
  const API_TTS = "/GeaAsistenteHub/api/tts.ashx";

  let ttsProvider = (params.get("tts") || "").toLowerCase()
    || localStorage.getItem("gea_tts_provider")
    || "browser";

  let speaking = false;
  let audioEl = null;
  let recognition = null;
  let listening = false;
  let activeMode = "text";

  const chat = document.getElementById("chat");
  const txt = document.getElementById("txt");
  const btn = document.getElementById("btn");
  const minBtn = document.getElementById("min-btn");
  const closeBtn = document.getElementById("close-btn");
  const tabText = document.getElementById("tab-text");
  const tabVoice = document.getElementById("tab-voice");
  const panelText = document.getElementById("panelText");
  const panelVoice = document.getElementById("panelVoice");
  const footerText = document.getElementById("footerText");
  const footerVoice = document.getElementById("footerVoice");
  const micBtn = document.getElementById("mic-btn");
  const voiceStatus = document.getElementById("voice-status");
  const voiceAvatar = document.getElementById("voice-avatar");
  const voiceClose = document.getElementById("voice-close");

  function addMsg(text, who){
    const div = document.createElement("div");
    div.className = "msg " + (who === "me" ? "me" : "bot");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function setVoiceAvatar(isTalking){
    voiceAvatar.src = isTalking ? avatarTalking : avatarIdle;
  }

  async function ask(source = "text"){
    const q = (txt.value || "").trim();
    if(!q) return;

    txt.value = "";
    addMsg(q, "me");

    if (activeMode === "voice") {
      setVoiceStatus("Pensando...", false);
    }

    addMsg("Pensando...", "bot");

    try{
      const res = await fetch(API_CHAT, {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(q)
      });

      const raw = await res.text();

      if(!res.ok){
        chat.lastChild.textContent = "No pude conectar con el asistente. (" + res.status + ")";
        return;
      }

      let data = null;
      try { data = JSON.parse(raw); } catch(e) {}

      const answer = (data && (data.output || data.answer || data.respuesta))
        ? (data.output || data.answer || data.respuesta)
        : raw;

      chat.lastChild.textContent = answer || "No encontrÃ© respuesta.";

      if (activeMode === "voice"){
        setVoiceStatus("Hablando...", false);
        await speak(answer);
      }
    }catch(err){
      console.error("Error en fetch:", err);
      chat.lastChild.textContent = "Error de conexiÃ³n. Verifica tu servicio.";
      if (activeMode === "voice"){
        setVoiceStatus("OcurriÃ³ un error. Intenta de nuevo.", false);
      }
    }
  }

  function stopSpeaking(){
    if (audioEl){
      try { audioEl.pause(); } catch(e){}
      try { audioEl.src = ""; } catch(e){}
      audioEl = null;
    }
    if ("speechSynthesis" in window){
      try { speechSynthesis.cancel(); } catch(e){}
    }
    speaking = false;
    setVoiceAvatar(false);
  }

  async function speak(text){
    if (!text || activeMode !== "voice") return;

    stopSpeaking();
    speaking = true;
    setVoiceAvatar(true);

    if (ttsProvider === "browser"){
      if (!("speechSynthesis" in window)){
        setVoiceStatus("Este navegador no soporta sÃ­ntesis de voz.", false);
        speaking = false;
        setVoiceAvatar(false);
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-MX";
      u.rate = 1;
      u.pitch = 1;
      u.onend = () => {
        speaking = false;
        setVoiceAvatar(false);
        setVoiceStatus("Listo para escucharte.", false);
      };
      u.onerror = () => {
        speaking = false;
        setVoiceAvatar(false);
        setVoiceStatus("No pude reproducir la voz.", false);
      };
      speechSynthesis.speak(u);
      return;
    }

    try{
      const r = await fetch(API_TTS, {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify({ text, provider: ttsProvider, lang: "es-MX" })
      });

      if (!r.ok){
        setVoiceStatus("No pude generar voz (" + r.status + ").", false);
        speaking = false;
        setVoiceAvatar(false);
        return;
      }

      const buf = await r.arrayBuffer();
      const ct = r.headers.get("Content-Type") || "audio/mpeg";
      const blob = new Blob([buf], { type: ct });
      const url = URL.createObjectURL(blob);

      audioEl = new Audio(url);
      audioEl.onended = () => {
        URL.revokeObjectURL(url);
        audioEl = null;
        speaking = false;
        setVoiceAvatar(false);
        setVoiceStatus("Listo para escucharte.", false);
      };
      audioEl.onerror = () => {
        URL.revokeObjectURL(url);
        audioEl = null;
        speaking = false;
        setVoiceAvatar(false);
        setVoiceStatus("No pude reproducir la voz.", false);
      };

      await audioEl.play();
    }catch(e){
      setVoiceStatus("Error reproduciendo voz.", false);
      speaking = false;
      setVoiceAvatar(false);
    }
  }

  function setVoiceStatus(message, isActive){
    voiceStatus.textContent = message;
    micBtn.classList.toggle("active", isActive);
  }

  function stopListening(){
    if (recognition && listening){
      recognition.stop();
    }
    listening = false;
    setVoiceStatus("Listo para escucharte.", false);
  }

  function startListening(){
    stopSpeaking();
    if (!recognition){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition){
        setVoiceStatus("Tu navegador no soporta reconocimiento de voz.", false);
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = "es-MX";
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("result", (event) => {
        const transcript = Array.from(event.results)
          .map((result) => result[0]?.transcript || "")
          .join("")
          .trim();
        if (transcript){
          if (event.results[event.results.length - 1].isFinal){
            txt.value = transcript;
            stopListening();
            ask("voice");
          } else {
            setVoiceStatus("Escuchando...", true);
          }
        }
      });

      recognition.addEventListener("error", () => {
        setVoiceStatus("No pude escuchar. Intenta de nuevo.", false);
        listening = false;
      });

      recognition.addEventListener("end", () => {
        if (listening){
          setVoiceStatus("No se detectÃ³ voz. Intenta nuevamente.", false);
          listening = false;
        }
      });
    }

    listening = true;
    setVoiceStatus("Escuchando...", true);
    recognition.start();
  }

  function updateMode(mode){
    activeMode = mode;
    const isText = mode === "text";
    tabText.classList.toggle("active", isText);
    tabText.setAttribute("aria-selected", isText.toString());
    tabVoice.classList.toggle("active", !isText);
    tabVoice.setAttribute("aria-selected", (!isText).toString());
    panelText.style.display = isText ? "flex" : "none";
    footerText.style.display = isText ? "block" : "none";
    panelVoice.style.display = isText ? "none" : "flex";
    footerVoice.style.display = isText ? "none" : "flex";
    if (isText){
      stopListening();
      stopSpeaking();
      txt.focus();
    }
  }

  function closeWidget(){
    window.parent?.postMessage({ type: "GEA_CHAT_CLOSE" }, "*");
  }

  btn.addEventListener("click", () => ask());
  txt.addEventListener("keydown", (e) => {
    if (e.key === "Enter") ask();
  });

  window.addEventListener("message", (e) => {
    if(e.data?.type === "GEA_CHAT_OPEN"){
      setTimeout(() => txt.focus(), 50);
    }
  });

  minBtn.addEventListener("click", closeWidget);
  closeBtn.addEventListener("click", closeWidget);
  voiceClose.addEventListener("click", closeWidget);

  tabText.addEventListener("click", () => updateMode("text"));
  tabVoice.addEventListener("click", () => updateMode("voice"));

  micBtn.addEventListener("click", () => {
    if (listening){
      stopListening();
      return;
    }
    startListening();
  });

  addMsg(
    "Hola ðŸ‘‹, soy tu asistente virtual del Gobierno de Aguascalientes.\n" +
    "Puedo ayudarte a:\n" +
    "â€¢ Consultar informaciÃ³n de trÃ¡mites estatales y municipales\n" +
    "â€¢ Conocer requisitos y costos\n" +
    "â€¢ Ver el estatus de tu trÃ¡mite con tu folio\n" +
    "Â¿En quÃ© puedo ayudarte hoy?",
    "bot"
  );
</script>
</body>
</html>
